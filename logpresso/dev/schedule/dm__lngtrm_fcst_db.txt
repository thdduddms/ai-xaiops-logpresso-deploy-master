실행 주기 : 0 1 * * *
경보 사용 : null

set from=datetrunc(dateadd(now(), "day", -1), "1d") 
| set to=datetrunc(dateadd(now(), "day", 0), "1d")
| set floor_decimal =2

| table from=$("from") to=$("to") exem_aiops_anls_inst_db
| search inst_product_type=="ORACLE" 
| eval _time = datetrunc(_time, "1d")
| stats avg(active_sessions) as active_sessions, avg(buffer_busy_waits) as buffer_busy_waits, avg(concurrency_wait_time) as concurrency_wait_time, avg(consistent_gets) as consistent_gets, avg(cpu_used_by_this_session) as cpu_used_by_this_session, avg(cursor_pin_s_wait_on_x) as cursor_pin_s_wait_on_x, avg(db_block_changes) as db_block_changes, avg(db_block_gets) as db_block_gets, avg(db_file_scattered_read) as db_file_scattered_read, avg(db_file_sequential_read) as db_file_sequential_read, avg(db_time) as db_time, avg(enq_sq_contention) as enq_sq_contention, avg(enq_tx_index_contention) as enq_tx_index_contention, avg(enq_tx_row_lock_contention) as enq_tx_row_lock_contention, avg(enqueue_requests) as enqueue_requests, avg(enqueue_waits) as enqueue_waits, avg(execute_count) as execute_count, avg(file_io_service_time) as file_io_service_time, avg(file_io_wait_time) as file_io_wait_time, avg(free_buffer_waits) as free_buffer_waits, avg(gc_buffer_busy_acquire) as gc_buffer_busy_acquire, avg(gc_buffer_busy_release) as gc_buffer_busy_release, avg(gc_cr_block_busy) as gc_cr_block_busy, avg(gc_cr_blocks_received) as gc_cr_blocks_received, avg(gc_cr_multi_block_request) as gc_cr_multi_block_request, avg(gc_cr_request) as gc_cr_request, avg(gc_current_block_busy) as gc_current_block_busy, avg(gc_current_blocks_received) as gc_current_blocks_received, avg(gc_current_multi_block_request) as gc_current_multi_block_request, avg(gc_current_request) as gc_current_request, avg(global_enqueue_gets_async) as global_enqueue_gets_async, avg(global_enqueue_gets_sync) as global_enqueue_gets_sync, avg(latch_cache_buffers_chains) as latch_cache_buffers_chains, avg(latch_shared_pool) as latch_shared_pool, avg(library_cache_lock) as library_cache_lock, avg(library_cache_mutex_x) as library_cache_mutex_x, avg(library_cache_pin) as library_cache_pin, avg(lock_waiting_sessions) as lock_waiting_sessions, avg(log_buffer_space) as log_buffer_space, avg(log_file_sequential_read) as log_file_sequential_read, avg(log_file_switch_archiving_needed) as log_file_switch_archiving_needed, avg(log_file_switch_checkpoint_incomplete) as log_file_switch_checkpoint_incomplete, avg(log_file_switch_completion) as log_file_switch_completion, avg(log_file_sync) as log_file_sync, avg(non_idle_wait_time) as non_idle_wait_time, avg(parse_time_elapsed) as parse_time_elapsed, avg(physical_reads) as physical_reads, avg(physical_reads_direct) as physical_reads_direct, avg(physical_writes) as physical_writes, avg(physical_writes_direct) as physical_writes_direct, avg(read_by_other_session) as read_by_other_session, avg(recursive_calls) as recursive_calls, avg(redo_size) as redo_size, avg(row_cache_lock) as row_cache_lock, avg(session_logical_reads) as session_logical_reads, avg(user_calls) as user_calls, avg(user_commits) as user_commits, avg(user_rollbacks) as user_rollbacks
        by _time,  _target, system_id
| eval time = string(_time, "yyyy-MM-dd HH:mm:ss")
       , active_sessions=floor(active_sessions, $("floor_decimal")), buffer_busy_waits=floor(buffer_busy_waits, $("floor_decimal")), concurrency_wait_time=floor(concurrency_wait_time, $("floor_decimal")), consistent_gets=floor(consistent_gets, $("floor_decimal")), cpu_used_by_this_session=floor(cpu_used_by_this_session, $("floor_decimal")), cursor_pin_s_wait_on_x=floor(cursor_pin_s_wait_on_x, $("floor_decimal")), db_block_changes=floor(db_block_changes, $("floor_decimal")), db_block_gets=floor(db_block_gets, $("floor_decimal")), db_file_scattered_read=floor(db_file_scattered_read, $("floor_decimal")), db_file_sequential_read=floor(db_file_sequential_read, $("floor_decimal")), db_time=floor(db_time, $("floor_decimal")), enq_sq_contention=floor(enq_sq_contention, $("floor_decimal")), enq_tx_index_contention=floor(enq_tx_index_contention, $("floor_decimal")), enq_tx_row_lock_contention=floor(enq_tx_row_lock_contention, $("floor_decimal")), enqueue_requests=floor(enqueue_requests, $("floor_decimal")), enqueue_waits=floor(enqueue_waits, $("floor_decimal")), execute_count=floor(execute_count, $("floor_decimal")), file_io_service_time=floor(file_io_service_time, $("floor_decimal")), file_io_wait_time=floor(file_io_wait_time, $("floor_decimal")), free_buffer_waits=floor(free_buffer_waits, $("floor_decimal")), gc_buffer_busy_acquire=floor(gc_buffer_busy_acquire, $("floor_decimal")), gc_buffer_busy_release=floor(gc_buffer_busy_release, $("floor_decimal")), gc_cr_block_busy=floor(gc_cr_block_busy, $("floor_decimal")), gc_cr_blocks_received=floor(gc_cr_blocks_received, $("floor_decimal")), gc_cr_multi_block_request=floor(gc_cr_multi_block_request, $("floor_decimal")), gc_cr_request=floor(gc_cr_request, $("floor_decimal")), gc_current_block_busy=floor(gc_current_block_busy, $("floor_decimal")), gc_current_blocks_received=floor(gc_current_blocks_received, $("floor_decimal")), gc_current_multi_block_request=floor(gc_current_multi_block_request, $("floor_decimal")), gc_current_request=floor(gc_current_request, $("floor_decimal")), global_enqueue_gets_async=floor(global_enqueue_gets_async, $("floor_decimal")), global_enqueue_gets_sync=floor(global_enqueue_gets_sync, $("floor_decimal")), latch_cache_buffers_chains=floor(latch_cache_buffers_chains, $("floor_decimal")), latch_shared_pool=floor(latch_shared_pool, $("floor_decimal")), library_cache_lock=floor(library_cache_lock, $("floor_decimal")), library_cache_mutex_x=floor(library_cache_mutex_x, $("floor_decimal")), library_cache_pin=floor(library_cache_pin, $("floor_decimal")), lock_waiting_sessions=floor(lock_waiting_sessions, $("floor_decimal")), log_buffer_space=floor(log_buffer_space, $("floor_decimal")), log_file_sequential_read=floor(log_file_sequential_read, $("floor_decimal")), log_file_switch_archiving_needed=floor(log_file_switch_archiving_needed, $("floor_decimal")), log_file_switch_checkpoint_incomplete=floor(log_file_switch_checkpoint_incomplete, $("floor_decimal")), log_file_switch_completion=floor(log_file_switch_completion, $("floor_decimal")), log_file_sync=floor(log_file_sync, $("floor_decimal")), non_idle_wait_time=floor(non_idle_wait_time, $("floor_decimal")), parse_time_elapsed=floor(parse_time_elapsed, $("floor_decimal")), physical_reads=floor(physical_reads, $("floor_decimal")), physical_reads_direct=floor(physical_reads_direct, $("floor_decimal")), physical_writes=floor(physical_writes, $("floor_decimal")), physical_writes_direct=floor(physical_writes_direct, $("floor_decimal")), read_by_other_session=floor(read_by_other_session, $("floor_decimal")), recursive_calls=floor(recursive_calls, $("floor_decimal")), redo_size=floor(redo_size, $("floor_decimal")), row_cache_lock=floor(row_cache_lock, $("floor_decimal")), session_logical_reads=floor(session_logical_reads, $("floor_decimal")), user_calls=floor(user_calls, $("floor_decimal")), user_commits=floor(user_commits, $("floor_decimal")), user_rollbacks=floor(user_rollbacks, $("floor_decimal"))
| eval target_id=_target
| fields _time, time, system_id, _target, target_id, active_sessions, buffer_busy_waits, concurrency_wait_time, consistent_gets, cpu_used_by_this_session, cursor_pin_s_wait_on_x, db_block_changes, db_block_gets, db_file_scattered_read, db_file_sequential_read, db_time, enq_sq_contention, enq_tx_index_contention, enq_tx_row_lock_contention, enqueue_requests, enqueue_waits, execute_count, file_io_service_time, file_io_wait_time, free_buffer_waits, gc_buffer_busy_acquire, gc_buffer_busy_release, gc_cr_block_busy, gc_cr_blocks_received, gc_cr_multi_block_request, gc_cr_request, gc_current_block_busy, gc_current_blocks_received, gc_current_multi_block_request, gc_current_request, global_enqueue_gets_async, global_enqueue_gets_sync, latch_cache_buffers_chains, latch_shared_pool, library_cache_lock, library_cache_mutex_x, library_cache_pin, lock_waiting_sessions, log_buffer_space, log_file_sequential_read, log_file_switch_archiving_needed, log_file_switch_checkpoint_incomplete, log_file_switch_completion, log_file_sync, non_idle_wait_time, parse_time_elapsed, physical_reads, physical_reads_direct, physical_writes, physical_writes_direct, read_by_other_session, recursive_calls, redo_size, row_cache_lock, session_logical_reads, user_calls, user_commits, user_rollbacks
| import exem_aiops_lngtrm_fcst_db

| # evtctx 
| fields _time, system_id, _target
| stats count by _time, system_id, _target
| eval module = "exem_aiops_lngtrm_fcst", target_type = "db", key= concat(module, "_", target_type, "_", _target)
| evtctxadd key=key topic="mart_result" maxrows=10 isnotnull(_target)
| drop 

| # TIBERO
| set from=datetrunc(dateadd(now(), "day", -1), "1d") 
| set to=datetrunc(dateadd(now(), "day", 0), "1d")
| table from=$("from") to=$("to") exem_aiops_anls_inst_db
| search inst_product_type=="TIBERO" 
| eval _time = datetrunc(_time, "1d")
| stats avg(cr_block_received) as cr_block_received, avg(db_cpu) as db_cpu, avg(execute_count) as execute_count, avg(hard_parse_elapsed_time) as hard_parse_elapsed_time, avg(lock_waiting_sessions) as lock_waiting_sessions, avg(parse_count_failures) as parse_count_failures, avg(parse_count_hard) as parse_count_hard, avg(parse_count_total) as parse_count_total, avg(parse_time_elapsed) as parse_time_elapsed, avg(physical_reads) as physical_reads, avg(redo_entries) as redo_entries, avg(redo_log_size) as redo_log_size, avg(running_sessions) as running_sessions, avg(session_logical_reads) as session_logical_reads, avg(sort_time) as sort_time, avg(sorts_disk) as sorts_disk, avg(sorts_memory) as sorts_memory, avg(transactions) as transactions, avg(user_calls) as user_calls, avg(user_rollbacks) as user_rollbacks, avg(we_buf_wait) as we_buf_wait, avg(we_ccc_ast_cr) as we_ccc_ast_cr, avg(we_ccc_ast_cur) as we_ccc_ast_cur, avg(we_ccc_ast_mbr) as we_ccc_ast_mbr, avg(we_jc_buf_disk_read) as we_jc_buf_disk_read, avg(we_jc_buf_disk_readm) as we_jc_buf_disk_readm, avg(we_jc_dbwr_write_os) as we_jc_dbwr_write_os, avg(we_jc_dpbuf_wait_write) as we_jc_dpbuf_wait_write, avg(we_log_flush_commit) as we_log_flush_commit, avg(we_spin_alloc_lru) as we_spin_alloc_lru, avg(we_spin_buf_bucket) as we_spin_buf_bucket, avg(we_spin_buf_ws) as we_spin_buf_ws, avg(we_spin_shp_alloc) as we_spin_shp_alloc, avg(we_wlock_cf) as we_wlock_cf, avg(we_wlock_df_extend) as we_wlock_df_extend, avg(we_wlock_dml) as we_wlock_dml, avg(we_wlock_seq_get_nextval) as we_wlock_seq_get_nextval, avg(we_wlock_sess) as we_wlock_sess, avg(we_wlock_split) as we_wlock_split, avg(we_wlock_temp_granule) as we_wlock_temp_granule, avg(we_wlock_tx) as we_wlock_tx
        by _time,  _target, system_id
| eval time = string(_time, "yyyy-MM-dd HH:mm:ss")
       , cr_block_received=floor(cr_block_received, $("floor_decimal")), db_cpu=floor(db_cpu, $("floor_decimal")), execute_count=floor(execute_count, $("floor_decimal")), hard_parse_elapsed_time=floor(hard_parse_elapsed_time, $("floor_decimal")), lock_waiting_sessions=floor(lock_waiting_sessions, $("floor_decimal")), parse_count_failures=floor(parse_count_failures, $("floor_decimal")), parse_count_hard=floor(parse_count_hard, $("floor_decimal")), parse_count_total=floor(parse_count_total, $("floor_decimal")), parse_time_elapsed=floor(parse_time_elapsed, $("floor_decimal")), physical_reads=floor(physical_reads, $("floor_decimal")), redo_entries=floor(redo_entries, $("floor_decimal")), redo_log_size=floor(redo_log_size, $("floor_decimal")), running_sessions=floor(running_sessions, $("floor_decimal")), session_logical_reads=floor(session_logical_reads, $("floor_decimal")), sort_time=floor(sort_time, $("floor_decimal")), sorts_disk=floor(sorts_disk, $("floor_decimal")), sorts_memory=floor(sorts_memory, $("floor_decimal")), transactions=floor(transactions, $("floor_decimal")), user_calls=floor(user_calls, $("floor_decimal")), user_rollbacks=floor(user_rollbacks, $("floor_decimal")), we_buf_wait=floor(we_buf_wait, $("floor_decimal")), we_ccc_ast_cr=floor(we_ccc_ast_cr, $("floor_decimal")), we_ccc_ast_cur=floor(we_ccc_ast_cur, $("floor_decimal")), we_ccc_ast_mbr=floor(we_ccc_ast_mbr, $("floor_decimal")), we_jc_buf_disk_read=floor(we_jc_buf_disk_read, $("floor_decimal")), we_jc_buf_disk_readm=floor(we_jc_buf_disk_readm, $("floor_decimal")), we_jc_dbwr_write_os=floor(we_jc_dbwr_write_os, $("floor_decimal")), we_jc_dpbuf_wait_write=floor(we_jc_dpbuf_wait_write, $("floor_decimal")), we_log_flush_commit=floor(we_log_flush_commit, $("floor_decimal")), we_spin_alloc_lru=floor(we_spin_alloc_lru, $("floor_decimal")), we_spin_buf_bucket=floor(we_spin_buf_bucket, $("floor_decimal")), we_spin_buf_ws=floor(we_spin_buf_ws, $("floor_decimal")), we_spin_shp_alloc=floor(we_spin_shp_alloc, $("floor_decimal")), we_wlock_cf=floor(we_wlock_cf, $("floor_decimal")), we_wlock_df_extend=floor(we_wlock_df_extend, $("floor_decimal")), we_wlock_dml=floor(we_wlock_dml, $("floor_decimal")), we_wlock_seq_get_nextval=floor(we_wlock_seq_get_nextval, $("floor_decimal")), we_wlock_sess=floor(we_wlock_sess, $("floor_decimal")), we_wlock_split=floor(we_wlock_split, $("floor_decimal")), we_wlock_temp_granule=floor(we_wlock_temp_granule, $("floor_decimal")), we_wlock_tx=floor(we_wlock_tx, $("floor_decimal"))
| eval target_id=_target
| fields _time, time, system_id, _target, target_id, cr_block_received, db_cpu, execute_count, hard_parse_elapsed_time, lock_waiting_sessions, parse_count_failures, parse_count_hard, parse_count_total, parse_time_elapsed, physical_reads, redo_entries, redo_log_size, running_sessions, session_logical_reads, sort_time, sorts_disk, sorts_memory, transactions, user_calls, user_rollbacks, we_buf_wait, we_ccc_ast_cr, we_ccc_ast_cur, we_ccc_ast_mbr, we_jc_buf_disk_read, we_jc_buf_disk_readm, we_jc_dbwr_write_os, we_jc_dpbuf_wait_write, we_log_flush_commit, we_spin_alloc_lru, we_spin_buf_bucket, we_spin_buf_ws, we_spin_shp_alloc, we_wlock_cf, we_wlock_df_extend, we_wlock_dml, we_wlock_seq_get_nextval, we_wlock_sess, we_wlock_split, we_wlock_temp_granule, we_wlock_tx
| import exem_aiops_lngtrm_fcst_db 

| # evtctx 
| fields _time, system_id, _target
| stats count by _time, system_id, _target
| eval module = "exem_aiops_lngtrm_fcst", target_type = "db", key= concat(module, "_", target_type, "_", _target)
| evtctxadd key=key topic="mart_result" maxrows=10 isnotnull(_target)