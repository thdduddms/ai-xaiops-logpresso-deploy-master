파라미터 : [string standard_datetime, int sys_id, string inst_type]
설명 : exem_aiops_anls_inst 모듈 대상

# set standard_datetime=202306071030  | # set sys_id=102 | set module = "exem_aiops_anls_inst" | # set inst_type = ""
| set to = dateadd( date( $("standard_datetime"), "yyyyMMddHHmm"), "min", 1)
| set from = dateadd( date( $("standard_datetime"), "yyyyMMddHHmm"), "min", -59)
 | set _table=concat($("module"), "_", $("inst_type"))
| table from=$("from") to=$("to") order=asc $(_table)
| search system_id == $("sys_id")
| # search _target=="214"
| rename system_id as sys_id, _target as target_id
| eval _body=case(
			_table=="exem_aiops_anls_inst_was",  dict( "time", time, "file_count", file_count, "prepare_count", prepare_count, "cpu_time", cpu_time, "socket_count", socket_count, "active_tx_count", active_tx_count, "gc_count", gc_count, "heap_usage", heap_usage, "active_db_conn_count", active_db_conn_count, "fetch_time", fetch_time, "fetch_count", fetch_count, "gc_time", gc_time, "call_count", call_count, "tps", tps, "prepare_time", prepare_time, "sql_count", sql_count, "extcall_time", extcall_time, "response_time", response_time, "thread_count", thread_count, "cpu_usage", cpu_usage, "sql_time", sql_time, "extcall_count", extcall_count, "fail_count", fail_count),
			_table=="exem_aiops_anls_inst_db" and inst_product_type=="ORACLE", dict("active_sessions", active_sessions, "buffer_busy_waits", buffer_busy_waits, "concurrency_wait_time", concurrency_wait_time, "consistent_gets", consistent_gets, "cpu_used_by_this_session", cpu_used_by_this_session, "cursor_pin_s_wait_on_x", cursor_pin_s_wait_on_x, "db_block_changes", db_block_changes, "db_block_gets", db_block_gets, "db_file_scattered_read", db_file_scattered_read, "db_file_sequential_read", db_file_sequential_read, "db_time", db_time, "enq_sq_contention", enq_sq_contention, "enq_tx_index_contention", enq_tx_index_contention, "enq_tx_row_lock_contention", enq_tx_row_lock_contention, "enqueue_requests", enqueue_requests, "enqueue_waits", enqueue_waits, "execute_count", execute_count, "file_io_service_time", file_io_service_time, "file_io_wait_time", file_io_wait_time, "free_buffer_waits", free_buffer_waits, "gc_buffer_busy_acquire", gc_buffer_busy_acquire, "gc_buffer_busy_release", gc_buffer_busy_release, "gc_cr_block_busy", gc_cr_block_busy, "gc_cr_blocks_received", gc_cr_blocks_received, "gc_cr_multi_block_request", gc_cr_multi_block_request, "gc_cr_request", gc_cr_request, "gc_current_block_busy", gc_current_block_busy, "gc_current_blocks_received", gc_current_blocks_received, "gc_current_multi_block_request", gc_current_multi_block_request, "gc_current_request", gc_current_request, "global_enqueue_gets_async", global_enqueue_gets_async, "global_enqueue_gets_sync", global_enqueue_gets_sync, "latch_cache_buffers_chains", latch_cache_buffers_chains, "latch_shared_pool", latch_shared_pool, "library_cache_lock", library_cache_lock, "library_cache_mutex_x", library_cache_mutex_x, "library_cache_pin", library_cache_pin, "lock_waiting_sessions", lock_waiting_sessions, "log_buffer_space", log_buffer_space, "log_file_sequential_read", log_file_sequential_read, "log_file_switch_archiving_needed", log_file_switch_archiving_needed, "log_file_switch_checkpoint_incomplete", log_file_switch_checkpoint_incomplete, "log_file_switch_completion", log_file_switch_completion, "log_file_sync", log_file_sync, "non_idle_wait_time", non_idle_wait_time, "parse_time_elapsed", parse_time_elapsed, "physical_reads", physical_reads, "physical_reads_direct", physical_reads_direct, "physical_writes", physical_writes, "physical_writes_direct", physical_writes_direct, "read_by_other_session", read_by_other_session, "recursive_calls", recursive_calls, "redo_size", redo_size, "row_cache_lock", row_cache_lock, "session_logical_reads", session_logical_reads, "solution", solution, "time", time, "user_calls", user_calls, "user_commits", user_commits, "user_rollbacks", user_rollbacks),  
			_table=="exem_aiops_anls_inst_db" and inst_product_type=="TIBERO", dict("buffer_busy_waits", buffer_busy_waits, "cr_block_received", cr_block_received, "db_cpu", db_cpu, "db_file_scattered_read", db_file_scattered_read, "db_file_sequential_read", db_file_sequential_read, "enq_tx_index_contention", enq_tx_index_contention, "enqueue_waits", enqueue_waits, "execute_count", execute_count, "file_io_service_time", file_io_service_time, "global_enqueue_gets_async", global_enqueue_gets_async, "global_enqueue_gets_sync", global_enqueue_gets_sync, "hard_parse_elapsed_time", hard_parse_elapsed_time, "latch_cache_buffers_chains", latch_cache_buffers_chains, "lock_waiting_sessions", lock_waiting_sessions, "log_file_sequential_read", log_file_sequential_read, "log_file_switch_completion", log_file_switch_completion, "parse_count_failures", parse_count_failures, "parse_count_hard", parse_count_hard, "parse_count_total", parse_count_total, "parse_time_elapsed", parse_time_elapsed, "physical_reads", physical_reads, "physical_writes_direct", physical_writes_direct, "redo_entries", redo_entries, "redo_log_size", redo_log_size, "running_sessions", running_sessions, "session_logical_reads", session_logical_reads, "solution", solution, "sort_time", sort_time, "sorts_disk", sorts_disk, "sorts_memory", sorts_memory, "time", time, "transactions", transactions, "user_calls", user_calls, "user_rollbacks", user_rollbacks, "we_buf_wait", we_buf_wait, "we_ccc_ast_cr", we_ccc_ast_cr, "we_ccc_ast_cur", we_ccc_ast_cur, "we_ccc_ast_mbr", we_ccc_ast_mbr, "we_jc_buf_disk_read", we_jc_buf_disk_read, "we_jc_buf_disk_readm", we_jc_buf_disk_readm, "we_jc_dbwr_write_os", we_jc_dbwr_write_os, "we_jc_dpbuf_wait_write", we_jc_dpbuf_wait_write, "we_log_flush_commit", we_log_flush_commit, "we_spin_alloc_lru", we_spin_alloc_lru, "we_spin_buf_bucket", we_spin_buf_bucket, "we_spin_buf_ws", we_spin_buf_ws, "we_spin_shp_alloc", we_spin_shp_alloc, "we_wlock_cf", we_wlock_cf, "we_wlock_df_extend", we_wlock_df_extend, "we_wlock_dml", we_wlock_dml, "we_wlock_seq_get_nextval", we_wlock_seq_get_nextval, "we_wlock_sess", we_wlock_sess, "we_wlock_split", we_wlock_split, "we_wlock_temp_granule", we_wlock_temp_granule, "we_wlock_tx", we_wlock_tx), 
			_table=="exem_aiops_anls_inst_os", dict("cpu_idle", cpu_idle, "cpu_system", cpu_system, "cpu_usage", cpu_usage, "cpu_usage_max", cpu_usage_max, "cpu_user", cpu_user, "disk_usage", disk_usage,"memory_usage", memory_usage, "memory_used", memory_used, "network", network, "phy_free", phy_free, "phy_total", phy_total, "rx_bytes_delta", rx_bytes_delta, "rx_discards_delta", rx_discards_delta, "rx_errors_delta", rx_errors_delta, "rx_pkts_delta", rx_pkts_delta, "swap_free", swap_free, "swap_total", swap_total, "swap_used", swap_used, "time", time, "tx_bytes_delta", tx_bytes_delta, "tx_discards_delta", tx_discards_delta, "tx_errors_delta", tx_errors_delta, "tx_pkts_delta", tx_pkts_delta), 
			_table=="exem_aiops_anls_inst_tp", dict("count_avg", count_avg, "count_sum", count_sum, "cq_count_avg", cq_count_avg, "cq_count_sum", cq_count_sum, "elapsed_avg", elapsed_avg, "elapsed_sum", elapsed_sum, "emcount_avg", emcount_avg, "emcount_sum", emcount_sum, "error_count", error_count, "fail_count", fail_count, "q_elapsed_avg", q_elapsed_avg, "q_elapsed_sum", q_elapsed_sum, "qcount_avg", qcount_avg, "qcount_sum", qcount_sum, "qpcount_avg", qpcount_avg, "qpcount_sum", qpcount_sum, "status_nrdy", status_nrdy, "status_rdy", status_rdy, "target_id", target_id, "time", time),
			_table=="exem_aiops_anls_inst_web", dict("active_txns", active_txns, "active_txns_max", active_txns_max, "active_txns_min", active_txns_min, "active_txns_sum", active_txns_sum, "client_count", client_count, "client_count_max", client_count_max, "client_count_min", client_count_min, "client_count_sum", client_count_sum, "code_100", code_100, "code_200", code_200, "code_300", code_300, "code_400", code_400, "code_500", code_500, "count", count, "elapsed_critical", elapsed_critical, "elapsed_critical_max", elapsed_critical_max, "elapsed_critical_min", elapsed_critical_min, "elapsed_normal", elapsed_normal, "elapsed_normal_max", elapsed_normal_max, "elapsed_normal_min", elapsed_normal_min, "elapsed_time", elapsed_time, "elapsed_warning", elapsed_warning, "elapsed_warning_max", elapsed_warning_max, "elapsed_warning_min", elapsed_warning_min, "error_count", error_count, "time", time, "txn_end_count", txn_end_count, "txn_end_count_max", txn_end_count_max, "txn_end_count_min", txn_end_count_min, "txn_end_count_sum", txn_end_count_sum), 
			_table=="exem_aiops_anls_inst_network", dict("cpu_usage", cpu_usage, "dev_ip", dev_ip, "event_count", event_count, "inbps", inbps, "inpps", inpps, "memory_usage", memory_usage, "network_id", network_id, "outbps", outbps, "outpps", outpps, "time", time, "user_dev_name", user_dev_name) 
)
 | sort time
 
| # stats array(_body)  as _body , max(time) as time by target_id
| stats array(_body)  as _body by target_id
| eval module=$("module")
| eval inst_type=$("inst_type"), sys_id = $("sys_id"), datet=substr($("from"), 0, 8)

| join type=left sys_id [ json "{}" 
|  eval url=concat( "http://10.10.34.21:14568/redis/business-calendar?systemId=", $("sys_id"), "&yyyyMMdd=", datet)
|  wget method=post | parsejson line | eval sys_id=$("sys_id"), data=data | fields data, sys_id ]

| eval  _header=dict("sys_id", sys_id, "inst_type", inst_type, "target_id", target_id, "business_list", data)
| eval payload=dict("id1", module, "date", str(now(), "yyyyMMddHHmm"), "standard_datetime", $("standard_datetime"), "uid", "", "_header", _header, "_body", _body) 
| eval _time= date( $("standard_datetime"), "yyyyMMddHHmm")
| fields target_id, payload, _time
|  sftp aitr2 put 
format=json 
partition=t append=t 
fields=target_id,payload /home/aiops/serving_request_data/module_{logtime:yyyyMMdd}.txt
| # sftp ssh_ai_collector put 
format=json 
partition=t append=t 
fields=target_id,payload /home/aic1/logpresso/script/test_yr/module3_{logtime:yyyyMMdd}.txt